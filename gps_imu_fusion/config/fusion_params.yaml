ekf_fusion_node:
  ros__parameters:
    # 2D 평면 모드: Z 무시 (z, v_z, a_z 모두 무효화)
    two_d_mode: true
    # 프레임 ID 설정
    world_frame_id: "odom"
    base_frame_id: "base_link"
    gnss_frame_id: "gps"
    imu_frame_id: "os_imu"
    
    # 일반 설정
    update_rate: 50.0       # EKF 업데이트 주기 (Hz)
    # update_rate:
    #   높일수록 더 빠른 응답을 얻을 수 있지만 CPU 사용량이 증가함
    #   10-50Hz 범위가 적당함
    #   IMU 데이터 속도의 약 1/2~1/3 정도로 설정하는 것이 좋음
    publish_tf: true        # TF 변환 발행 여부
    
    # 자세 추정 관련
    mag_declination: -8.0    # 자기 편각 (도)
    # 자기 편각:
    #   현재 위치의 자기 편각을 정확히 설정하면 방향 추정 정확도가 향상됨
    #   한국의 경우 약 -8도 (서편각)
    #   정확한 값은 NOAA 자기장 계산기에서 확인
    use_magnetic_declination: false  # 자기 편각 보정 사용 여부
    use_gnss_heading: true  # GNSS 헤딩을 사용할지 여부 (속도가 충분히 있을 때)
    # use_gnss_heading:
    #   true: 차량이 충분한 속도로 이동 중일 때 GNSS 방향각을 사용
    #   false: 항상 EKF 추정 헤딩 사용
    #   직선 주행이 많은 경우 true 권장
    #   제자리 회전이 많은 경우 false 권장
    
    # ===== ZUPT 3상태 전환 시스템 =====
    # EKF는 속도에 따라 3가지 상태로 동작하여 최적의 센서 융합 수행:
    #
    # ┌─────────────┬──────────────┬────────────────┬──────────────────┐
    # │    상태     │  속도 범위   │  GPS Heading   │   융합 전략      │
    # ├─────────────┼──────────────┼────────────────┼──────────────────┤
    # │ 1. 정지     │ < 0.08 m/s   │ OFF (무시)     │ IMU only         │
    # │             │              │ noise = 1000   │ Q scale = 0.1    │
    # ├─────────────┼──────────────┼────────────────┼──────────────────┤
    # │ 2. 전환     │ 0.08~1.0 m/s │ 극히 높은 가중치│ GPS heading only │
    # │   (저속)    │              │ noise = 0.001  │ Q scale = 1.0    │
    # ├─────────────┼──────────────┼────────────────┼──────────────────┤
    # │ 3. 주행     │ > 1.0 m/s    │ 보통 가중치    │ GPS/IMU 균형     │
    # │   (고속)    │              │ noise = 0.1    │ Q scale = 1.0    │
    # └─────────────┴──────────────┴────────────────┴──────────────────┘
    #
    # 핵심 철학:
    # - 정지: GPS heading OFF + IMU 업데이트 1/10 + Q 스케일 0.1 = 3중 drift 억제
    # - 전환: IMU 무시하고 오직 GPS heading만으로 yaw 결정 (noise=0.001)
    # - 주행: GPS와 IMU를 균형있게 융합하여 동적 성능 확보
    
    # [상태 전환 속도 임계값 - 히스테리시스]
    zupt_speed_threshold_low: 0.08   # 정지 진입 속도 (m/s)
    # 이 속도 아래로 내려가면 정지 상태 진입 검토
    # 정지 시: GPS heading 완전 차단 (noise=1000)
    # 목적: GPS 노이즈로 인한 헤딩 떨림 방지
    
    zupt_speed_threshold_high: 0.24  # 이동 진입 속도 (m/s)
    # 이 속도 위로 올라가면 이동 상태(전환/주행) 진입
    # 0.08~0.12 구간: 히스테리시스 갭 (채터링 방지)
    
    # [상태 전환 지연 시간]
    zupt_hold_time: 0.3              # 정지 상태 전환 유지 시간 (s)
    # 정지 조건 만족 후 이 시간 동안 유지되어야 실제 정지로 판단
    # 순간적인 속도 변동에 의한 오판 방지
    
    zupt_release_time: 0.3           # 정지→이동 전환 유지 시간 (s)  
    # 정지→이동 전환 시 속도가 0.12 m/s 이상 유지되어야 하는 시간
    # 정지/이동 2상태 전환용 (transition_min_hold_time과는 다른 역할)
    
    # [상태별 프로세스 노이즈 (Q 행렬) 스케일링]
    zupt_noise_scale_stationary: 0.1 # 정지 상태 Q 스케일
    # 정지 상태: IMU 드리프트 최소화를 위해 Q 축소
    # yaw와 gyro-bias-Z 노이즈를 10%로 줄임
    # GPS heading OFF 상태에서 IMU 안정성 확보
    # 0.1 = 드리프트 억제와 실제 회전 반응성의 균형점
    
    zupt_noise_scale_moving: 1.0     # 이동 상태 Q 스케일
    # 전환/주행 상태: 정상 프로세스 노이즈 사용
    # GPS heading이 활성화되어 IMU 보정 가능
    # 1.0 = 동적 움직임에 대한 완전한 반응성
    
    # [IMU 기반 보조 정지 감지 (선택적)]
    zupt_gyro_threshold: 0.01        # 자이로 정지 판단 임계값 (rad/s)
    # 3축 자이로 norm이 이 값 미만이면 IMU 정지로 판단
    # GPS 속도와 OR 조건으로 결합하여 정지 감지 강화
    # 0.01 rad/s = 약 0.57 deg/s
    
    zupt_accel_threshold: 0.1        # 가속도 정지 판단 임계값 (m/s^2)
    # 가속도 크기와 중력(9.8m/s^2)의 차이가 이 값 미만이면 정지
    # 진동/충격이 없는 정지 상태 감지용
    
    # [정지 상태 IMU 업데이트 decimation]
    stationary_imu_decimation_factor: 125  # 정지 상태 IMU 업데이트 비율 (1/N)
    # 정지 상태에서 IMU 업데이트 빈도를 줄여 drift 억제
    # 10 = 10번 중 1번만 IMU 업데이트 (90% 스킵)
    # 효과: yaw drift 속도를 1/10로 감소
    # 부작용: 정지 중 실제 회전에 대한 반응 속도 저하
    # 권장: 5~20 범위 (작을수록 반응 빠름, 클수록 drift 억제)

    # ===== GPS Heading 측정 노이즈 (R 행렬) - 3상태 시스템 =====
    # 속도별 3상태 전환에 따른 GPS heading 신뢰도 조절
    # 칼만 필터 R 행렬(측정 노이즈)를 동적으로 변경
    
    # [상태 1: 정지 (< 0.08 m/s)]
    gps_heading_noise_low: 1000.0    # 정지 상태 - GPS heading 차단
    # GPS heading valid = false로 설정되어 실제로는 사용 안함
    # 1000 rad = 사실상 무한대 불확실성
    # 정지 시 GPS 방향각은 랜덤 노이즈이므로 완전 차단
    # IMU 자이로만으로 헤딩 유지
    
    # [상태 2: 전환 (0.08~1.0 m/s)]
    gps_heading_noise_mid: 0.001     # 전환 상태 - GPS heading만 사용
    # 0.001 rad = 약 0.057도 표준편차 (매우 작음)
    # 저속 이동 시 IMU를 거의 무시하고 GPS heading만 신뢰
    # EKF가 GPS heading을 거의 100% 따라감
    # 전환 구간에서 "오직 GPS heading으로만 yaw 업데이트"
    
    # [상태 3: 주행 (> 1.0 m/s)]
    gps_heading_noise_high: 0.01      # 주행 상태 - GPS/IMU 균형 융합
    # 0.1 rad = 약 5.7도 표준편차
    # 고속에서 GPS와 IMU를 균형있게 융합
    # 동적 움직임에서 양 센서의 장점 활용
    
    speed_threshold_mid: 0.5         # 전환/주행 경계 속도 (m/s)
    # 전환 상태와 주행 상태를 구분하는 속도
    # 1.0 m/s = 3.6 km/h (빠른 걷기)
    
    # [전환 상태 최소 유지 시간]
    transition_min_hold_time: 0.4    # 전환 상태 최소 유지 시간 (s)
    # 전환 상태(0.08~1.0 m/s)에 진입하면 최소 이 시간 동안 유지
    # 속도가 1.0 m/s를 넘어도 이 시간 동안은 GPS heading 높은 가중치 유지
    # 목적: GPS heading으로 yaw 보정이 완료될 때까지 충분한 시간 확보
    # 오버슛 방지: 보정 중간에 노이즈가 바뀌는 것을 방지
    # 1.0초 = GPS heading으로 IMU 오차를 충분히 보정할 수 있는 시간

    # ===== Lever Arm Compensation Thresholds =====
    # 레버암 보상 관련 임계값 설정
    lever_arm_min_len_m: 0.001       # 최소 레버암 길이 (m)
    # 이 값보다 작은 레버암은 무시하여 불필요한 계산을 방지
    # 0.001m = 1mm (GPS/IMU가 거의 같은 위치에 있을 때)
    # 일반적인 설정: 0.001~0.01m
    
    imu_dt_min_s: 0.0001             # IMU 각가속도 계산 최소 시간 간격 (s)
    # 너무 짧은 시간 간격으로 인한 수치 오류 방지
    # 0.0001s = 0.1ms (10kHz 이상 IMU 대응)
    # 권장: IMU 주기의 1/10 이상
    
    imu_dt_max_s: 0.1                # IMU 각가속도 계산 최대 시간 간격 (s)
    # 너무 긴 시간 간격으로 인한 부정확한 각가속도 방지
    # 0.1s = 100ms (10Hz 이하 IMU 대응)
    # 권장: IMU 주기의 10배 이하
    
    alpha_max_rad_s2: 100.0          # 최대 각가속도 제한값 (rad/s²)
    # 비현실적인 각가속도 값 방지 (노이즈/스파이크 제거)
    # 100 rad/s² = 약 5730 deg/s²
    # 일반 차량: 50~100 rad/s²
    # 고기동 로봇: 100~200 rad/s²
    # 드론: 200~500 rad/s²

    # === 실험용 EKF 파라미터 ===
    
    # 프로세스 노이즈 파라미터 (값이 클수록 측정값을 더 신뢰함)
    accel_noise: 0.05       # 가속도계 출력 노이즈의 표준편차 (m/s^2)
    # accel_noise: 
    #   가속도계의 노이즈 수준을 나타냄 
    #   값이 클수록 가속도계 측정값을 덜 신뢰함 
    #   부드러운 움직임이 필요하면 값을 높임 (0.1-0.5) 
    #   반응성이 필요하면 값을 낮춤 (0.01-0.05) 
    #   센서 테스트: 정지 상태에서 가속도계 출력의 표준편차를 측정하여 설정 
    gyro_noise: 0.00175     # 자이로 출력 노이즈의 표준편차 (rad/s)
    # gyro_noise: 
    #   자이로스코프의 노이즈 수준을 나타냄 
    #   값이 클수록 자이로 측정값을 덜 신뢰함 
    #   부드러운 자세 추정이 필요하면 값을 높임 (0.005-0.01) 
    #   빠른 회전 추적이 필요하면 값을 낮춤 (0.0005-0.002) 
    #   센서 테스트: 정지 상태에서 자이로 출력의 표준편차를 측정하여 설정 
    accel_bias_noise: 0.01  # 가속도계 바이어스 표준편차 (m/s^2)
    gyro_bias_noise: 0.00025 # 자이로 바이어스 표준편차 (rad/s)
    # accel_bias_noise / gyro_bias_noise: 
    #   바이어스의 랜덤 워크 특성을 모델링 
    #   값이 클수록 바이어스가 더 빨리 변할 것으로 예상 
    #   고품질 IMU는 낮은 값 사용 (0.001-0.005 / 0.00005-0.0001) 
    #   저렴한 IMU는 높은 값 사용 (0.01-0.05 / 0.0005-0.001) 
    #   장기 테스트: 온도 안정화 후 장시간 바이어스 변화를 관찰하여 조정 
    accel_bias_tau: 100.0   # 가속도계 바이어스 시간 상수 (s)
    gyro_bias_tau: 50.0     # 자이로 바이어스 시간 상수 (s)
    # accel_bias_tau / gyro_bias_tau: 
    #   바이어스의 상관 시간 (높을수록 바이어스가 천천히 변함) 
    #   고품질 IMU는 높은 값 사용 (300-600s / 100-300s) 
    #   저렴한 IMU는 낮은 값 사용 (50-100s / 30-50s) 
    #   실험 조정: 바이어스 추정이 얼마나 빨리 수렴하는지 관찰하며 조정 


    # 측정 노이즈 파라미터 (값이 작을수록 GPS를 더 신뢰함)
    gps_pos_noise_ne: 0.2   # GPS 위치 노이즈 표준편차 (북-동) (m)
    gps_pos_noise_d: 1.0    # GPS 위치 노이즈 표준편차 (하) (m)
    # gps_pos_noise_ne / gps_pos_noise_d: 
    #   GPS 위치 측정의 표준편차 
    #   값이 작을수록 GPS 위치를 더 신뢰함 
    #   개방된 공간: 낮은 값 (1.0-3.0m / 3.0-6.0m) 
    #   도심/숲: 높은 값 (5.0-10.0m / 10.0-15.0m) 
    #   RTK GPS: 매우 낮은 값 (0.1-0.5m / 0.2-1.0m) 
    gps_vel_noise_ne: 0.5   # GPS 속도 노이즈 표준편차 (북-동) (m/s)
    gps_vel_noise_d: 1.0    # GPS 속도 노이즈 표준편차 (하) (m/s)
    # gps_vel_noise_ne / gps_vel_noise_d: 
    #   GPS 속도 측정의 표준편차 
    #   값이 작을수록 GPS 속도를 더 신뢰함
    #   일반적인 범위: 0.1-2.0 m/s
    #   속도가 부드럽지 않으면 값을 높이세요
    #   가속/감속 추적이 부정확하면 값을 낮추세요
    #   공분산 정보가 이미 메시지에 포함되어 있으면 해당 값이 우선 적용됨
    
    
    # 초기 공분산 파라미터 (초기 불확실성)
    init_pos_unc: 10.0      # 초기 위치 불확실성 (m)
    init_vel_unc: 1.0       # 초기 속도 불확실성 (m/s)
    # init_pos_unc / init_vel_unc: 
    #   초기 위치/속도 불확실성 
    #   일반적으로 이 값들은 GPS 정확도에 따라 설정 
    #   위치: 정지 시작 5-10m, 이동 중 시작 20-50m 
    #   속도: 정지 시작 0.1-0.5m/s, 이동 중 시작 1-5m/s 
    init_att_unc: 0.34906   # 초기 자세 불확실성 (rad), ~20도
    init_hdg_unc: 3.14159   # 초기 헤딩 불확실성 (rad), ~180도
    # init_att_unc / init_hdg_unc: 
    #   초기 롤/피치 및 요 불확실성 
    #   롤/피치: IMU 품질에 따라 0.1-0.5rad 
    #   헤딩: 초기 방향 정보 없을 때 π rad (180도) 
    #   자기장 또는 초기 정렬 정보가 있으면 헤딩 불확실성 낮춤 (0.1-0.5rad) 
    init_accel_bias_unc: 0.981 # 초기 가속도계 바이어스 불확실성 (m/s^2)
    init_gyro_bias_unc: 0.01745 # 초기 자이로 바이어스 불확실성 (rad/s)
    # init_accel_bias_unc / init_gyro_bias_unc: 
    #   초기 가속도/자이로 바이어스 불확실성 
    #   가속도계: 일반적으로 0.5-1.0 m/s² 
    #   자이로: 일반적으로 0.01-0.05 rad/s 
    #   센서 품질에 따라 조정
    
    # IMU Calibration 파일 경로 (패키지 상대 경로)
    imu_calibration_file: ""
    # imu_calibration_file:
    #   IMU bias 및 Allan variance 분석 결과가 포함된 JSON 파일 경로
    #   예: "config/improved_imu_calibration.json" (패키지 상대 경로)
    #   빈 문자열("")로 설정하면 calibration 파일을 사용하지 않음
