# GPS-IMU Fusion 패키지 분석 보고서

## 1. 현재 적용 상태

### 1.1 IMU Calibration 적용 현황
- **적용된 부분**:
  - 가속도계 bias: [0.0527, 0.1221, 0.1666] m/s²
  - 자이로 bias: [0.0096, 0.0003, 0.0186] rad/s
  - `kai_ekf_core.cpp`의 `setImuCalibration()` 함수를 통해 bias 값 적용

- **미적용 부분**:
  - Allan variance의 bias stability 값 (로드만 하고 활용 안 함)
  - Scale factor 보정
  - Axis misalignment 보정
  - Temperature compensation

### 1.2 EKF 구현 상태
- 15-state EKF (위치 3, 속도 3, 자세 3, 가속도 bias 3, 자이로 bias 3)
- GPS 위치/속도와 IMU 데이터 융합
- 프로세스 노이즈 및 측정 노이즈 모델링

## 2. 장단점 분석

### 2.1 장점
1. **커스터마이징 용이성**
   - 소스 코드 직접 수정 가능
   - 특정 센서 구성에 최적화 가능
   - 추가 센서 통합 시 유연한 대응

2. **단순한 의존성**
   - robot_localization 패키지 불필요
   - 최소한의 외부 라이브러리 사용

3. **전처리 로직 통합**
   - IMU calibration 데이터 직접 활용
   - 센서별 특성을 고려한 처리 가능

### 2.2 단점

#### Critical 이슈 (즉시 수정 필요)
1. **Race Condition**
   - `std::shared_mutex` 선언했지만 getter 함수에서 미사용
   - 멀티스레드 환경에서 데이터 경합 위험

2. **수치적 불안정성**
   - Gimbal lock 근처에서 NaN 발생 가능
   - asin() 입력값 범위 제한 불완전

3. **시간 동기화 부재**
   - IMU와 GPS 타임스탬프 동기화 없음
   - 센서 간 지연 시간 고려 안 함

4. **비정상 dt 처리**
   - dt ≤ 0일 때도 계속 진행
   - 필터 발산 위험

#### High 이슈
- 초기화 순서 문제 (GPS 의존적)
- Allan variance 데이터 미활용
- JSON 파싱 취약성
- 오류 복구 메커니즘 부재

## 3. robot_localization 대비 평가

| 항목 | 직접 구현 EKF | robot_localization |
|------|--------------|-------------------|
| 안정성 | ❌ 검증되지 않음 | ✅ 광범위하게 검증됨 |
| 유지보수 | ❌ 자체 유지보수 필요 | ✅ 커뮤니티 지원 |
| 문서화 | ❌ 부족 | ✅ 충분한 문서 |
| 성능 | ⭕ 특정 케이스 최적화 가능 | ✅ 일반적으로 우수 |
| 확장성 | ⭕ 직접 구현 필요 | ✅ 다양한 센서 지원 |

## 4. 파이프라인 통합 적합성

### 4.1 현재 상태: ❌ **부적합**

**주요 문제점**:
1. 멀티스레딩 안전성 미보장
2. 시간 동기화 부재로 부정확한 상태 추정
3. 오류 발생 시 복구 불가능
4. 좌표계 변환 문제 (아래 참조)

### 4.2 개선 필요사항
1. 모든 getter 함수에 thread-safe 접근 구현
2. 센서 타임스탬프 기반 동기화
3. 공분산 행렬 체크 및 리셋 로직
4. 좌표계 변환 명확화

## 5. 좌표계 문제 분석

### 5.1 의심되는 문제
1. **base_link → map 직접 연결**
   - 일반적인 ROS2 구조: map → odom → base_link
   - 현재: map → base_link (odom 프레임 무시)

2. **원점 설정 문제**
   - 첫 GPS 데이터 수신 위치를 (0,0)으로 설정하는 것으로 추정
   - GPS to Cartesian 변환이 제대로 적용되지 않는 증상

### 5.2 확인 필요사항
- TF tree 구조 확인
- GPS reference point 설정 방식
- EKF 초기화 시 좌표 설정

## 6. 권장사항

### 6.1 단기 (테스트용)
1. scripts의 GPS 변환 도구로 좌표계 문제 디버깅
2. 간단한 시나리오에서 동작 확인
3. 로그를 통한 문제점 파악

### 6.2 장기 (프로덕션)
1. **robot_localization으로 마이그레이션**
   - 안정성과 유지보수성 확보
   - 검증된 좌표계 변환 사용
   
2. **현재 코드 유지 시**
   - Critical 이슈 4개 즉시 수정
   - 좌표계 변환 로직 재구현
   - 포괄적인 테스트 스위트 작성

## 7. 결론

현재 직접 구현한 EKF는 학습 목적으로는 가치가 있으나, 실제 로봇 시스템에 적용하기에는 여러 치명적 결함이 있습니다. 특히 좌표계 변환 문제와 스레드 안전성 문제는 즉각적인 시스템 오류를 유발할 수 있습니다.

테스트를 위해 scripts 디렉토리의 도구를 활용하되, 최종적으로는 robot_localization 패키지로의 전환을 강력히 권장합니다.