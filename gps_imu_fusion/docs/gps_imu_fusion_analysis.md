# GPS-IMU Fusion 패키지 분석 보고서 (2025.08 최신)

## 1. 현재 구현 상태

### 1.1 핵심 기능 (구현 완료)
- **15-state EKF**: 위치(3), 속도(3), 자세(3), 가속도 bias(3), 자이로 bias(3)
- **ZUPT (Zero Velocity Update)**: 3단계 속도 기반 히스테리시스 적용
- **GPS Heading 융합**: 속도별 동적 노이즈 조절로 GPS/IMU 균형 융합
- **좌표계 변환**: UTM 변환 및 로컬 카르테시안 좌표계 구현
- **스레드 안전성**: shared_mutex로 멀티스레드 환경 대응

### 1.2 IMU Calibration 현황
- 자이로 bias만 EKF에서 온라인 추정
- 가속도계 bias는 전처리 단계에서 처리 가정
- Allan variance, scale factor 등 고급 calibration 미구현

## 2. ZUPT 및 GPS Heading 융합 구현

### 2.1 3단계 속도 기반 융합 전략 (구현 완료)
```
┌─────────────┬──────────────┬────────────────┬──────────────────┐
│    상태      │  속도 범위     │  GPS Heading   │   융합 전략        │
├─────────────┼──────────────┼────────────────┼──────────────────┤
│ 1. 정지      │ < 0.08 m/s   │ OFF (무시)      │ IMU only         │
│             │              │ noise = 1000   │ Q scale = 0.1    │
├─────────────┼──────────────┼────────────────┼──────────────────┤
│ 2. 전환      │ 0.08~0.5 m/s │ 극히 높은 가중치  │ GPS heading 우선  │
│   (저속)     │              │ noise = 0.001  │ Q scale = 1.0    │
├─────────────┼──────────────┼────────────────┼──────────────────┤
│ 3. 주행      │ > 0.5 m/s    │ 보통 가중치      │ GPS/IMU 균형      │
│   (고속)     │              │ noise = 0.1    │ Q scale = 1.0    │
└─────────────┴──────────────┴────────────────┴──────────────────┘
```

### 2.2 히스테리시스 적용
- 정지→이동 전환: 0.12 m/s 이상, 0.3초 유지
- 이동→정지 전환: 0.08 m/s 이하, 0.3초 유지
- 전환 상태 최소 유지: 0.4초 (GPS heading 보정 시간 확보)
- IMU 정지 감지와 OR 조건으로 결합

## 3. 좌표계 및 TF 변환 구조

### 3.1 현재 구현
- **TF 발행**: odom → base_link (ekf_fusion_node.cpp:786-813)
- **원점**: 건국대 일감호 고정 (37.540091, 127.076555)
- **좌표 변환**: GPS → UTM → 로컬 카르테시안
- **고도 처리**: `z = ekf_alt_m - reference_altitude_`

### 3.2 Lever Arm 보정 ✅ 완료 (2025.08.27)
- **GPS 안테나**: base_link에서 (0.5m, 0, 0.2m) 오프셋 → TF로 자동 보정
- **IMU**: base_link에서 (-0.3m, 0, 0) 오프셋 → TF로 자동 보정
- **구현 완료**: GPS position/velocity, IMU acceleration에 대한 lever arm dynamics 보정

## 4. 해결된 문제들

### 4.1 Critical 이슈 (✅ 해결)
- **스레드 안전성**: shared_mutex 올바르게 구현
- **비정상 dt 처리**: dt ≤ 0 시 스킵
- **수치적 안정성**: asin() 범위 제한, 쿼터니언 NaN 체크
- **ZUPT 구현**: 3단계 속도 기반 융합 완료
- **GPS Heading 융합**: 동적 노이즈 조절 구현
- **Lever Arm 보정**: GPS/IMU lever arm dynamics 완전 구현 (2025.08.27)

## 5. 남아있는 문제

### 5.1 High Priority
- **시간 동기화 부재**: IMU와 GPS 타임스탬프 동기화 없음
  - 상세 계획: [시간 동기화 구현 계획](./time_synchronization_plan.md) (예정)
- **Lever arm 보정**: ✅ 완료 (2025.08.27)
  - GPS position/velocity 및 IMU 가속도 lever arm 보정 구현 완료
  - TF 방향 문제 및 프레임 불일치 수정 완료
- **ZUPT 관련 문제**: 정지/이동 전환 시 불안정성 발생
  - IMU 정지 감지와 GPS 속도 기반 판단 간 충돌
  - 전환 상태(transition state) 로직 개선 필요
  - 히스테리시스 파라미터 재조정 필요
- **IMU calibration 미적용**: ~~JSON 파일 미사용~~ (해결됨)

### 5.2 Medium Priority
- **오류 복구 메커니즘 부재**: 센서 실패 시 대응 로직 없음
- **초기화 순서 문제**: GPS/GNSS velocity 모두 필요
- **map → odom TF 미발행**: SLAM 통합 시 필요

## 6. Lever Arm 보정 구현 완료 (2025.08.27)

### 6.1 구현된 보정 항목
- ✅ **GPS position lever arm**: `p_base = p_gps - R_wb * t_bg`
- ✅ **GPS velocity lever arm**: `v_base = v_gps - ω × (R_wb * t_bg)`  
- ✅ **IMU acceleration lever arm**: `a_base = a_imu - α×r - ω×(ω×r)`
- ✅ **TF 방향 수정**: `lookupTransform("base_link", source)` 형식으로 통일
- ✅ **프레임 일치 보장**: gnssVelCallback에서 base frame 각속도 사용

### 6.2 미구현 항목
- **고도 오프셋**: base_link 지면 높이(0.235m) 미적용
- **Higher-order terms**: 큰 lever arm(>0.5m)에 대한 고차항 미고려



## 7. 결론

### 7.1 현재 상태 요약
- **기본 기능 구현 완료**: EKF, ZUPT, GPS heading 융합
- **스레드 안전성 확보**: mutex 올바르게 구현
- **자동차 특화**: 평지 주행 가정, yaw rate 중심

### 7.2 주요 개선 필요사항
1. **ZUPT 안정성 개선**: 정지/이동 전환 시 불안정성 해결 필요
2. **시간 동기화**: 센서 간 타임스탬프 동기화
3. **고도 오프셋 추가**: 타이어 반지름 고려
4. **오류 복구**: 센서 실패 시 graceful degradation

### 7.3 평가
테스트 및 개발 목적으로 충분히 사용 가능한 상태. Lever arm 보정 완료로 정확도가 크게 향상됨. ZUPT 안정성 개선과 시간 동기화가 추가되면 프로덕션 수준 도달 가능.


## 8. 지연/시간정렬 분석 및 대응

### 8.1 왜 GPS-only보다 ‘뒤로’ 보이나
- 지연된 GPS를 현재에 바로 섞음: GPS가 측정→도착까지 100~200ms 지연되는 것이 일반적이며, 이를 과거 시각으로 되감지 않고 현재 상태에 바로 섞으면 추정이 과거 방향으로 당겨짐(뒤처져 보임).
- publish 시 ‘현재까지 예측(predict-to-now)’ 부족: 출력 시각까지 추가 예측이 없으면 출력 자체가 늦어짐(양자화 지연 포함).
- 프레임/스탬프/큐 정렬 문제: TF 시간 오프셋, 토픽 큐 지연, 센서 클럭 불일치 등도 동일한 효과를 유발.

코드 관점 핵심 포인트
- 현재 구현은 IMU 콜백마다 EKF 업데이트가 돌며, 그때 사용되는 GPS 측정은 “직전 GNSS 콜백에서 저장된 값”입니다. 새 GPS가 오기 전까지 같은 측정이 반복 적용되어 현재를 과거로 끌 수 있습니다.
  - IMU 경로에서 EKF 호출: `INS/gps_imu_fusion/src/kai_ekf_core.cpp:197`
  - EKF 내부에서 마지막 GPS 좌표/속도를 매 스텝 측정으로 사용: `INS/gps_imu_fusion/src/kai_ekf_core.cpp:170`, `:174`, `:283`

### 8.2 정량화(간단 모델)
- 기호: v=속도, L_gps=GPS 총 지연(측정→퓨전), T_pub=퍼블리시 주기, α=GPS 위치 칼만 이득(0~1).
- 평균 위치 오프셋 근사: Δx ≈ v · ( α·L_gps + T_pub/2 )
  - α·L_gps: 지연된 GPS를 현재에 섞어 생기는 당김(뒤로 끌림)
  - T_pub/2: 퍼블리시 양자화 평균 지연
- 예시(8 Hz GPS=125ms, 50 Hz publish=20ms):
  - v=5 m/s, α=0.5 → Δx≈5·(0.5·0.125+0.01)=≈0.375 m(평균)
  - v=10 m/s, α=0.4~0.8 → ≈0.25~0.75 m(평균), 최대는 α·L_gps 항 기준 ≈0.05~0.10 s×v

타임라인(예: GPS 8 Hz, IMU 100 Hz, Odom 50 Hz)
```
시간(ms):  0         50        100        150        200        250
           |---------|---------|----------|----------|----------|

IMU(100):   • • • • • • • • • • • • • • • • • • • • • • • • •
PREDICT:    P P P P P P P P P P P P P P P P P P P P P P P P P

ODOM(50):     ▮    ▮    ▮    ▮    ▮    ▮    ▮    ▮    ▮    ▮

GPS(8):     G____________________________G____________________
UPDATE:     U____________________________U____________________
```
— 이상적으로는 publish 직전에 현재 시각까지 예측해 내보내야 함.

### 8.3 대응 옵션(현실적 → 정석)
- A) 측정 게이팅(추천/간단)
  - 새 GPS가 올 때만 위치/속도 측정 업데이트를 적용. 그 사이 IMU 예측은 고주사율로 계속.
  - 구현 아이디어: “신규 GPS 도착 플래그”가 없으면 H의 pos/vel 행을 비활성화하거나 R를 크게 키워 사실상 무시.
  - 장점: 지연된 GPS를 반복 재사용해 현재를 끌어내리는 문제 제거. 구현 간단.
- B) GPS 외삽(extrapolation to now)
  - z_now ≈ z_last + v_gps · (t_now − t_gps)로 “현재 시각 측정”을 생성해 업데이트.
  - 장점: α·L_gps 항을 크게 줄임. 버퍼 없이도 체감 지연 대폭 감소.
  - 주의: 좌표계 일관성(ENU↔NED), UTM 변환, 속도 프레임 정합 필요.
- C) 정석: 상태 버퍼링 + 소급 업데이트(retroactive) + 현재로 재전개(repropagate)
  - robot_localization류 구현. GPS 도착 시 해당 타임스탬프로 과거 상태에 업데이트 후 현재까지 IMU로 재적분.
  - 장점: 지연 보상을 가장 정확히 처리. 단, 구현 복잡도↑(상태 버퍼, 재전분, 시간 관리).

### 8.4 레포 기준 구현 포인트(권장 순서)
1) 측정 게이팅 추가
   - “신규 GNSS 수신” 플래그가 없으면 EKF 위치/속도 측정 항을 비활성화(예: H 행 0 또는 R 매우 크게)하여 IMU 예측만 진행.
2) publish 직전 predict-to-now
   - 마지막 EKF 상태 시각→publish 시각(now)까지 소규모 예측 적용. 잔여 수 ms라도 양자화 지연을 줄임.
3) 외삽 옵션(선택)
   - z_now를 만들어 업데이트. 버퍼 없이도 체감 지연이 크게 개선됨.
4) 정석 구현(선택)
   - 상태 히스토리 버퍼 구축, 과거시각 업데이트 + 재전개.

### 8.5 튜닝으로 α 낮추기(즉효)
- GPS 위치 노이즈(R)를 완화하여 α(K_pos)를 낮춤.
  - `fusion_params.yaml`에서 `gps_pos_noise_ne`/`gps_pos_noise_d`를 0.5~1.0 m 수준으로 상향(또는 실제 메시지 공분산을 신뢰).
  - 과도한 상향은 추적성 저하를 유발하므로 도로/환경에 맞게 조정.
- IMU Q를 상황에 맞게 조정하여 예측 영향도 균형화.

관련 파라미터 위치
- `INS/gps_imu_fusion/config/fusion_params.yaml:196`(gps_pos_noise_ne), `:197`(gps_pos_noise_d)

### 8.6 검증 루틴(실전)
- L_gps 추정: 로그에서 `header.stamp`와 수신 시각의 차이를 모아 평균·분산 산출.
- 경로 기반 지연 추정: 거리 시계열 s(t)를 만들고 EKF vs GPS의 상호상관 최대점에서 시간 시프트를 구함(평균 지연 추정).
- 오프셋→α 역산: Δx/(v·(T_gps/2)) ≈ α 근사(등속 구간).
- rosbag 기반 재현: 동일 데이터로 파라미터/옵션별 비교.

### 8.7 빠른 체크리스트
- 센서 타임스탬프가 “측정 시각”인지 확인(콜백 now 사용 금지).
- 새 GPS일 때만 위치/속도 보정(게이팅) 또는 외삽으로 now 보정.
- publish 직전 predict-to-now 적용.
- TF/프레임/큐 정렬 확인(특히 odom↔base_link, gps 프레임).
- Q/R 튜닝으로 α 조절.

### 8.8 한 줄 요약
EKF가 본질적으로 느려서가 아니라, “지연된 GPS를 현재에 바로 섞음 +(now까지 예측 부족) + 시간 정렬 이슈” 때문에 뒤로 보입니다. 새 GPS에서만 보정하고(now 외삽/되감기·재전개) 출력 시 현재까지 예측하면 GPS-only 대비 뒤처짐은 사라지거나 수 cm로 줄어듭니다.
