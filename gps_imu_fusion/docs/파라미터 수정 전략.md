# EKF 파라미터 튜닝 가이드

## 1. 준비사항

### 1.1 필요한 패키지 설치
다음 패키지들이 필요합니다:
```bash
pip3 install numpy matplotlib scipy pyyaml pandas tabulate colorama
```

### 1.2 스크립트 환경 설정
튜닝 스크립트를 실행할 수 있는 권한을 부여합니다:
```bash
cd ~/KAI/src/gps_imu_fusion/ekf_tuning_scripts
chmod +x *.py
```

### 1.3 스크립트 파일 확인 및 추가
현재 `analyze_test_results.py` 스크립트가 빠져 있습니다. 이 스크립트를 `ekf_tuning_scripts` 디렉토리에 추가해주세요:
```bash
cd ~/KAI/src/gps_imu_fusion/ekf_tuning_scripts
# 앞서 생성한 analyze_test_results.py 스크립트를 이 디렉토리에 추가
```

### 1.4 디렉토리 구조 확인
튜닝 결과를 저장할 디렉토리가 있는지 확인합니다:
```bash
mkdir -p ~/KAI/src/gps_imu_fusion/ekf_tuning_results
```

## 2. 튜닝 방법

### 2.1 전체 자동 튜닝 프로세스 (추천 방법)
마스터 스크립트인 `ekf_param_tuner.py`를 사용하면 한 번에 모든 과정을 수행할 수 있습니다.

#### 2.1.1 기본 튜닝 실행
로봇이나 장치가 완전히 정지한 상태에서:
```bash
cd ~/KAI/src/gps_imu_fusion/ekf_tuning_scripts
python3 ekf_param_tuner.py -o ~/KAI/src/gps_imu_fusion/ekf_tuning_results/tune_$(date +%Y%m%d_%H%M%S)
```

이 명령은:
- IMU 노이즈 분석 (30초)
- GNSS 정확도 분석 (30초)
- IMU 바이어스 분석 (5분)
- 최적 파라미터 파일 생성
을 순차적으로 수행합니다.

#### 2.1.2 동적 테스트 포함 튜닝 실행
더 정확한 튜닝을 위해 정적 분석 후 동적 테스트를 수행할 수 있습니다:
```bash
cd ~/KAI/src/gps_imu_fusion/ekf_tuning_scripts
python3 ekf_param_tuner.py --test-params --static-duration 60 --bias-duration 300 --test-duration 120 -o ~/KAI/src/gps_imu_fusion/ekf_tuning_results/tune_$(date +%Y%m%d_%H%M%S)
```

이 명령은:
- 정적 분석 (정지 상태에서 수행)
- 여러 파라미터 세트 생성
- 동적 테스트 (이동 중 각 파라미터 세트 테스트)
- 최적 파라미터 선택
을 수행합니다.

### 2.2 단계별 수동 튜닝
각 분석 단계를 개별적으로 실행하고 싶다면 다음과 같이 수행할 수 있습니다.

#### 2.2.1 정적 분석 (정지 상태)
- IMU 노이즈 분석 (30초)
```bash
cd ~/KAI/src/gps_imu_fusion/ekf_tuning_scripts
python3 analyze_imu_noise.py -d 30 -o ~/KAI/src/gps_imu_fusion/ekf_tuning_results/static_analysis
```

- GNSS 정확도 분석 (60초)
```bash
python3 analyze_gnss_accuracy.py -d 60 -o ~/KAI/src/gps_imu_fusion/ekf_tuning_results/static_analysis
```

- IMU 바이어스 분석 (5분)
```bash
python3 analyze_imu_bias.py -d 300 -o ~/KAI/src/gps_imu_fusion/ekf_tuning_results/static_analysis
```

#### 2.2.2 파라미터 생성
```bash
python3 generate_ekf_params.py -i ~/KAI/src/gps_imu_fusion/ekf_tuning_results/static_analysis -o ~/KAI/src/gps_imu_fusion/ekf_tuning_results/parameters
```

#### 2.2.3 동적 테스트 (선택사항)
```bash
# 먼저 ROS2 백을 재생하거나 실제 로봇을 주행시킵니다
python3 test_ekf_params.py -p ~/KAI/src/gps_imu_fusion/ekf_tuning_results/parameters/ekf_fusion_params_base.yaml ~/KAI/src/gps_imu_fusion/ekf_tuning_results/parameters/ekf_fusion_params_gps_precise.yaml -t 120 -o ~/KAI/src/gps_imu_fusion/ekf_tuning_results/dynamic_tests
```

#### 2.2.4 테스트 결과 분석 (선택사항)
```bash
python3 analyze_test_results.py -r ~/KAI/src/gps_imu_fusion/ekf_tuning_results/dynamic_tests/test_test_results.json -o ~/KAI/src/gps_imu_fusion/ekf_tuning_results/analysis
```

### 2.3 ROS 백 파일 사용 (선택사항)
백 파일을 사용하여 오프라인으로 테스트하려면:

먼저 백 파일 재생:
```bash
ros2 bag play ~/KAI/src/gps_imu_fusion/ekf_tuning_bags/your_bag_file -r 1.0
```

별도 터미널에서 테스트 스크립트 실행:
```bash
cd ~/KAI/src/gps_imu_fusion/ekf_tuning_scripts
python3 test_ekf_params.py -p ~/KAI/src/gps_imu_fusion/ekf_tuning_results/parameters/*.yaml -o ~/KAI/src/gps_imu_fusion/ekf_tuning_results/bag_tests
```

## 3. 최종 파라미터 적용
최적화된 파라미터를 실제 시스템에 적용합니다:
```bash
# 원본 파라미터 백업
cp ~/KAI/src/gps_imu_fusion/config/fusion_params.yaml ~/KAI/src/gps_imu_fusion/config/fusion_params.yaml.backup

# 새 파라미터 복사
cp ~/KAI/src/gps_imu_fusion/ekf_tuning_results/tune_*/ekf_fusion_params_final.yaml ~/KAI/src/gps_imu_fusion/config/fusion_params.yaml
```

## 4. 스크립트별 세부 설명

### 4.1 analyze_imu_noise.py
- **목적**: IMU 노이즈 특성 분석
- **권장 시간**: 30-60초
- **주의사항**: 로봇이 완전히 정지한 상태에서 실행
- **결과**: accel_noise, gyro_noise 파라미터 추천

### 4.2 analyze_gnss_accuracy.py
- **목적**: GNSS 정확도 평가
- **권장 시간**: 60-120초
- **주의사항**: 로봇이 완전히 정지한 상태에서 실행, 가능한 개방된 공간에서 수행
- **결과**: gps_pos_noise_ne, gps_pos_noise_d, gps_vel_noise_ne, gps_vel_noise_d 파라미터 추천

### 4.3 analyze_imu_bias.py
- **목적**: IMU 바이어스 안정성 분석
- **권장 시간**: 최소 5분 (300초)
- **주의사항**: 로봇이 완전히 정지한 상태에서 실행, 온도 변화가 적은 환경에서 수행
- **결과**: accel_bias_noise, gyro_bias_noise, accel_bias_tau, gyro_bias_tau 파라미터 추천

### 4.4 generate_ekf_params.py
- **목적**: 분석 결과를 종합해 EKF 파라미터 파일 생성
- **입력**: 앞선 분석 결과들
- **결과**: 최적화된 EKF 파라미터 YAML 파일

### 4.5 test_ekf_params.py
- **목적**: 여러 파라미터 세트의 성능 비교
- **권장 시간**: 파라미터 세트당 60-120초
- **주의사항**: 직선 주행, 회전, 가속/감속 등 다양한 움직임 포함 권장
- **결과**: 각 파라미터 세트별 성능 데이터

### 4.6 analyze_test_results.py
- **목적**: 테스트 결과 분석 및 최적 파라미터 세트 선택
- **입력**: test_ekf_params.py의 결과 파일
- **결과**: 분석 보고서 및 최적 파라미터 파일

### 4.7 ekf_param_tuner.py
- **목적**: 전체 튜닝 프로세스 자동화
- **사용**: 다양한 옵션으로 전체 튜닝 과정 수행
- **결과**: 최적화된 최종 파라미터 파일

## 5. 문제 해결

- **스크립트 실행 오류**: Python 패키지가 올바르게 설치되었는지 확인하세요.
- **토픽 구독 실패**:
```bash
ros2 topic list
```
명령으로 필요한 토픽이 발행되고 있는지 확인하세요.
- **분석 결과 이상**:
  - 정적 분석 중 로봇이 움직였는지 확인
  - 센서 데이터 품질 확인
  - 필터링 알고리즘 변경 없이 파라미터만 조정 확인

각 단계의 결과 파일과 그래프를 검토하여 센서 특성과 최적 파라미터를 더 잘 이해할 수 있습니다.
